<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Employee Status Dashboard</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/+esm" type="module"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createClient } = window.supabase || {};
        const { Clock, User, Plus, Trash2, Edit2, LogOut, Eye, EyeOff } = window.lucide || {};

        // Initialize Supabase client
        const SUPABASE_URL = 'YOUR_SUPABASE_URL';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
        
        // Wait for supabase to load
        let supabase;
        if (window.supabase) {
            supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            // Fallback: load supabase from CDN
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/index.min.js';
            script.onload = () => {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            };
            document.head.appendChild(script);
        }

        const App = () => {
          const [view, setView] = useState('public'); // public, employee, admin
          const [employees, setEmployees] = useState([]);
          const [currentUser, setCurrentUser] = useState(null);
          const [loading, setLoading] = useState(true);
          const [showPassword, setShowPassword] = useState(false);

          // Login state
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');

          // Employee control state
          const [statusNote, setStatusNote] = useState('');
          const [busyDuration, setBusyDuration] = useState(30);

          // Admin state
          const [showAddModal, setShowAddModal] = useState(false);
          const [editingEmployee, setEditingEmployee] = useState(null);
          const [newEmployee, setNewEmployee] = useState({
            full_name: '',
            email: '',
            password: '',
            role: 'employee'
          });

          // Initialize and setup realtime subscription
          useEffect(() => {
            if (!supabase) return;
            
            checkUser();
            fetchEmployees();

            // Setup realtime subscription
            const channel = supabase
              .channel('public:profiles')
              .on('postgres_changes', 
                { event: '*', schema: 'public', table: 'profiles' }, 
                (payload) => {
                  console.log('Realtime update:', payload);
                  if (payload.eventType === 'INSERT') {
                    setEmployees(prev => [...prev, payload.new]);
                  } else if (payload.eventType === 'UPDATE') {
                    setEmployees(prev => 
                      prev.map(emp => emp.id === payload.new.id ? payload.new : emp)
                    );
                  } else if (payload.eventType === 'DELETE') {
                    setEmployees(prev => prev.filter(emp => emp.id !== payload.old.id));
                  }
                }
              )
              .subscribe();

            return () => {
              supabase.removeChannel(channel);
            };
          }, []);

          const checkUser = async () => {
            if (!supabase) return;
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
              const { data: profile } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', session.user.id)
                .single();
              setCurrentUser(profile);
              if (profile?.role === 'admin') {
                setView('admin');
              } else if (profile?.role === 'employee') {
                setView('employee');
              }
            }
            setLoading(false);
          };

          const fetchEmployees = async () => {
            if (!supabase) return;
            const { data, error } = await supabase
              .from('profiles')
              .select('*')
              .order('full_name');
            
            if (!error && data) {
              setEmployees(data);
            }
          };

          const handleLogin = async () => {
            if (!supabase) return;
            const { data, error } = await supabase.auth.signInWithPassword({
              email,
              password
            });
            
            if (!error) {
              checkUser();
            } else {
              alert('Login failed: ' + error.message);
            }
          };

          const handleLogout = async () => {
            if (!supabase) return;
            await supabase.auth.signOut();
            setCurrentUser(null);
            setView('public');
            setEmail('');
            setPassword('');
          };

          const updateStatus = async (status) => {
            if (!currentUser || !supabase) return;

            const updates = {
              status,
              status_note: statusNote,
              busy_until: status === 'busy' ? new Date(Date.now() + busyDuration * 60000).toISOString() : null,
              updated_at: new Date().toISOString()
            };

            const { error } = await supabase
              .from('profiles')
              .update(updates)
              .eq('id', currentUser.id);

            if (!error) {
              setCurrentUser({ ...currentUser, ...updates });
              if (status === 'free') {
                setStatusNote('');
              }
            }
          };

          const addEmployee = async () => {
            if (!supabase) return;
            // Create auth user
            const { data: authData, error: authError } = await supabase.auth.signUp({
              email: newEmployee.email,
              password: newEmployee.password
            });

            if (authError) {
              alert('Error creating user: ' + authError.message);
              return;
            }

            // Create profile
            const { error: profileError } = await supabase
              .from('profiles')
              .insert({
                id: authData.user.id,
                full_name: newEmployee.full_name,
                role: newEmployee.role,
                status: 'free',
                avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(newEmployee.full_name)}&background=4F46E5&color=fff&size=128`
              });

            if (!profileError) {
              setShowAddModal(false);
              setNewEmployee({ full_name: '', email: '', password: '', role: 'employee' });
            }
          };

          const deleteEmployee = async (id) => {
            if (!supabase) return;
            if (!confirm('Are you sure you want to delete this employee?')) return;
            
            await supabase.from('profiles').delete().eq('id', id);
          };

          const updateEmployee = async (id, updates) => {
            if (!supabase) return;
            await supabase
              .from('profiles')
              .update(updates)
              .eq('id', id);
            setEditingEmployee(null);
          };

          const getTimeRemaining = (busyUntil) => {
            if (!busyUntil) return null;
            const now = Date.now();
            const end = new Date(busyUntil).getTime();
            const diff = end - now;
            
            if (diff <= 0) return 'Expired';
            
            const minutes = Math.floor(diff / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
          };

          // Timer component
          const Timer = ({ busyUntil }) => {
            const [time, setTime] = useState(getTimeRemaining(busyUntil));

            useEffect(() => {
              const interval = setInterval(() => {
                setTime(getTimeRemaining(busyUntil));
              }, 1000);
              return () => clearInterval(interval);
            }, [busyUntil]);

            if (!time || time === 'Expired') return null;
            
            return React.createElement('div', { className: "flex items-center gap-1 text-sm font-semibold" },
              React.createElement(Clock, { className: "w-4 h-4" }),
              time
            );
          };

          // Employee Card Component
          const EmployeeCard = ({ employee }) => {
            const isFree = employee.status === 'free';
            const avatarUrl = employee.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(employee.full_name)}&background=4F46E5&color=fff&size=128`;

            return React.createElement('div', {
              className: `
                rounded-lg p-6 transition-all duration-300
                ${isFree 
                  ? 'bg-gradient-to-br from-green-500 to-green-600 shadow-lg scale-100' 
                  : 'bg-gradient-to-br from-red-500 to-red-600 opacity-60 scale-95'
                }
              `
            },
              React.createElement('div', { className: "flex flex-col items-center text-white" },
                React.createElement('img', {
                  src: avatarUrl,
                  alt: employee.full_name,
                  className: "w-24 h-24 rounded-full border-4 border-white shadow-lg mb-4"
                }),
                React.createElement('h3', { className: "text-xl font-bold mb-2" }, employee.full_name),
                React.createElement('div', {
                  className: `
                    px-4 py-1 rounded-full text-sm font-semibold mb-2
                    ${isFree ? 'bg-green-700' : 'bg-red-700'}
                  `
                }, isFree ? '✓ Available' : '✕ Busy'),
                employee.status_note && React.createElement('p', {
                  className: "text-sm text-center italic mt-2 bg-black bg-opacity-20 px-3 py-1 rounded"
                }, `"${employee.status_note}"`),
                !isFree && employee.busy_until && React.createElement('div', {
                  className: "mt-3 bg-black bg-opacity-20 px-3 py-2 rounded"
                }, React.createElement(Timer, { busyUntil: employee.busy_until }))
              )
            );
          };

          if (loading) {
            return React.createElement('div', {
              className: "min-h-screen bg-gray-900 flex items-center justify-center"
            }, React.createElement('div', { className: "text-white text-2xl" }, "Loading..."));
          }

          // Public View
          if (view === 'public') {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8"
            },
              React.createElement('div', { className: "max-w-7xl mx-auto" },
                React.createElement('div', { className: "flex justify-between items-center mb-8" },
                  React.createElement('h1', { className: "text-4xl font-bold text-white" }, "Employee Status Dashboard"),
                  React.createElement('button', {
                    onClick: () => setView('login'),
                    className: "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 flex items-center gap-2"
                  },
                    React.createElement(User, { className: "w-4 h-4" }),
                    " Staff Login"
                  )
                ),
                React.createElement('div', {
                  className: "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"
                },
                  employees
                    .sort((a, b) => {
                      if (a.status === 'free' && b.status !== 'free') return -1;
                      if (a.status !== 'free' && b.status === 'free') return 1;
                      return a.full_name.localeCompare(b.full_name);
                    })
                    .map(emp => React.createElement(EmployeeCard, { key: emp.id, employee: emp }))
                )
              )
            );
          }

          // Login View
          if (view === 'login') {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 flex items-center justify-center p-4"
            },
              React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-8 w-full max-w-md" },
                React.createElement('h2', { className: "text-2xl font-bold mb-6 text-gray-800" }, "Staff Login"),
                React.createElement('div', { className: "space-y-4" },
                  React.createElement('div', null,
                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Email"),
                    React.createElement('input', {
                      type: "email",
                      value: email,
                      onChange: (e) => setEmail(e.target.value),
                      onKeyPress: (e) => e.key === 'Enter' && handleLogin(),
                      className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    })
                  ),
                  React.createElement('div', null,
                    React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-1" }, "Password"),
                    React.createElement('div', { className: "relative" },
                      React.createElement('input', {
                        type: showPassword ? "text" : "password",
                        value: password,
                        onChange: (e) => setPassword(e.target.value),
                        onKeyPress: (e) => e.key === 'Enter' && handleLogin(),
                        className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent pr-10"
                      }),
                      React.createElement('button', {
                        type: "button",
                        onClick: () => setShowPassword(!showPassword),
                        className: "absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                      }, showPassword ? React.createElement(EyeOff, { className: "w-5 h-5" }) : React.createElement(Eye, { className: "w-5 h-5" }))
                    )
                  ),
                  React.createElement('button', {
                    onClick: handleLogin,
                    className: "w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 font-semibold"
                  }, "Login"),
                  React.createElement('button', {
                    onClick: () => setView('public'),
                    className: "w-full bg-gray-200 text-gray-700 py-2 rounded-lg hover:bg-gray-300 font-semibold"
                  }, "Back to Dashboard")
                )
              )
            );
          }

          // Employee Control Panel
          if (view === 'employee' && currentUser) {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8"
            },
              React.createElement('div', { className: "max-w-2xl mx-auto" },
                React.createElement('div', { className: "flex justify-between items-center mb-8" },
                  React.createElement('h1', { className: "text-3xl font-bold text-white" }, "Employee Control Panel"),
                  React.createElement('button', {
                    onClick: handleLogout,
                    className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"
                  },
                    React.createElement(LogOut, { className: "w-4 h-4" }),
                    " Logout"
                  )
                ),
                React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-8" },
                  React.createElement('div', { className: "flex items-center gap-4 mb-6" },
                    React.createElement('img', {
                      src: currentUser.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.full_name)}`,
                      alt: currentUser.full_name,
                      className: "w-20 h-20 rounded-full"
                    }),
                    React.createElement('div', null,
                      React.createElement('h2', { className: "text-2xl font-bold" }, currentUser.full_name),
                      React.createElement('p', {
                        className: `text-lg font-semibold ${currentUser.status === 'free' ? 'text-green-600' : 'text-red-600'}`
                      }, currentUser.status === 'free' ? 'Available' : 'Busy')
                    )
                  ),
                  React.createElement('div', { className: "space-y-4" },
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Status Note"),
                      React.createElement('input', {
                        type: "text",
                        value: statusNote,
                        onChange: (e) => setStatusNote(e.target.value),
                        placeholder: "e.g., In a meeting, Working on urgent task...",
                        className: "w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                      })
                    ),
                    statusNote && React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium text-gray-700 mb-2" }, "Busy Duration"),
                      React.createElement('div', { className: "flex gap-2" },
                        [15, 30, 60].map(duration => React.createElement('button', {
                          key: duration,
                          onClick: () => setBusyDuration(duration),
                          className: `flex-1 py-2 rounded-lg font-semibold ${
                            busyDuration === duration
                              ? 'bg-indigo-600 text-white'
                              : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
                          }`
                        }, `${duration}m`))
                      )
                    ),
                    React.createElement('div', { className: "flex gap-4 pt-4" },
                      React.createElement('button', {
                        onClick: () => updateStatus('free'),
                        className: "flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-bold text-lg"
                      }, "Set as Free"),
                      React.createElement('button', {
                        onClick: () => updateStatus('busy'),
                        className: "flex-1 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-bold text-lg"
                      }, "Set as Busy")
                    )
                  )
                ),
                React.createElement('button', {
                  onClick: () => setView('public'),
                  className: "mt-4 w-full py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-600"
                }, "View Public Dashboard")
              )
            );
          }

          // Admin Panel
          if (view === 'admin' && currentUser?.role === 'admin') {
            return React.createElement('div', {
              className: "min-h-screen bg-gradient-to-br from-gray-900 via-gray-800 to-gray-900 p-8"
            },
              React.createElement('div', { className: "max-w-6xl mx-auto" },
                React.createElement('div', { className: "flex justify-between items-center mb-8" },
                  React.createElement('h1', { className: "text-3xl font-bold text-white" }, "Admin Panel"),
                  React.createElement('div', { className: "flex gap-2" },
                    React.createElement('button', {
                      onClick: () => setView('public'),
                      className: "px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700"
                    }, "View Dashboard"),
                    React.createElement('button', {
                      onClick: handleLogout,
                      className: "px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 flex items-center gap-2"
                    },
                      React.createElement(LogOut, { className: "w-4 h-4" }),
                      " Logout"
                    )
                  )
                ),
                React.createElement('div', { className: "bg-white rounded-lg shadow-xl p-8" },
                  React.createElement('div', { className: "flex justify-between items-center mb-6" },
                    React.createElement('h2', { className: "text-2xl font-bold" }, "Manage Employees"),
                    React.createElement('button', {
                      onClick: () => setShowAddModal(true),
                      className: "px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center gap-2"
                    },
                      React.createElement(Plus, { className: "w-4 h-4" }),
                      " Add Employee"
                    )
                  ),
                  React.createElement('div', { className: "space-y-4" },
                    employees.map(emp => React.createElement('div', {
                      key: emp.id,
                      className: "flex items-center justify-between p-4 border border-gray-200 rounded-lg"
                    },
                      React.createElement('div', { className: "flex items-center gap-4" },
                        React.createElement('img', {
                          src: emp.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(emp.full_name)}`,
                          alt: emp.full_name,
                          className: "w-12 h-12 rounded-full"
                        }),
                        React.createElement('div', null,
                          React.createElement('h3', { className: "font-bold" }, emp.full_name),
                          React.createElement('p', { className: "text-sm text-gray-600" }, emp.role)
                        )
                      ),
                      React.createElement('div', { className: "flex gap-2" },
                        React.createElement('button', {
                          onClick: () => setEditingEmployee(emp),
                          className: "p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200"
                        }, React.createElement(Edit2, { className: "w-4 h-4" })),
                        emp.id !== currentUser.id && React.createElement('button', {
                          onClick: () => deleteEmployee(emp.id),
                          className: "p-2 bg-red-100 text-red-600 rounded hover:bg-red-200"
                        }, React.createElement(Trash2, { className: "w-4 h-4" }))
                      )
                    ))
                  )
                )
              ),
              // Add Employee Modal
              showAddModal && React.createElement('div', {
                className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",
                onClick: (e) => e.target.className.includes('fixed') && setShowAddModal(false)
              },
                React.createElement('div', {
                  className: "bg-white rounded-lg p-8 max-w-md w-full",
                  onClick: (e) => e.stopPropagation()
                },
                  React.createElement('h3', { className: "text-2xl font-bold mb-4" }, "Add New Employee"),
                  React.createElement('div', { className: "space-y-4" },
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Full Name"),
                      React.createElement('input', {
                        type: "text",
                        value: newEmployee.full_name,
                        onChange: (e) => setNewEmployee({...newEmployee, full_name: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      })
                    ),
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Email"),
                      React.createElement('input', {
                        type: "email",
                        value: newEmployee.email,
                        onChange: (e) => setNewEmployee({...newEmployee, email: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      })
                    ),
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Password"),
                      React.createElement('input', {
                        type: "password",
                        value: newEmployee.password,
                        onChange: (e) => setNewEmployee({...newEmployee, password: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      })
                    ),
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Role"),
                      React.createElement('select', {
                        value: newEmployee.role,
                        onChange: (e) => setNewEmployee({...newEmployee, role: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      },
                        React.createElement('option', { value: "employee" }, "Employee"),
                        React.createElement('option', { value: "admin" }, "Admin")
                      )
                    ),
                    React.createElement('div', { className: "flex gap-2 pt-4" },
                      React.createElement('button', {
                        onClick: addEmployee,
                        className: "flex-1 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                      }, "Add Employee"),
                      React.createElement('button', {
                        onClick: () => setShowAddModal(false),
                        className: "flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                      }, "Cancel")
                    )
                  )
                )
              ),
              // Edit Employee Modal
              editingEmployee && React.createElement('div', {
                className: "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4",
                onClick: (e) => e.target.className.includes('fixed') && setEditingEmployee(null)
              },
                React.createElement('div', {
                  className: "bg-white rounded-lg p-8 max-w-md w-full",
                  onClick: (e) => e.stopPropagation()
                },
                  React.createElement('h3', { className: "text-2xl font-bold mb-4" }, "Edit Employee"),
                  React.createElement('div', { className: "space-y-4" },
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Full Name"),
                      React.createElement('input', {
                        type: "text",
                        value: editingEmployee.full_name,
                        onChange: (e) => setEditingEmployee({...editingEmployee, full_name: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      })
                    ),
                    React.createElement('div', null,
                      React.createElement('label', { className: "block text-sm font-medium mb-1" }, "Role"),
                      React.createElement('select', {
                        value: editingEmployee.role,
                        onChange: (e) => setEditingEmployee({...editingEmployee, role: e.target.value}),
                        className: "w-full px-4 py-2 border rounded-lg"
                      },
                        React.createElement('option', { value: "employee" }, "Employee"),
                        React.createElement('option', { value: "admin" }, "Admin")
                      )
                    ),
                    React.createElement('div', { className: "flex gap-2 pt-4" },
                      React.createElement('button', {
                        onClick: () => updateEmployee(editingEmployee.id, {
                          full_name: editingEmployee.full_name,
                          role: editingEmployee.role,
                          avatar_url: `https://ui-avatars.com/api/?name=${encodeURIComponent(editingEmployee.full_name)}&background=4F46E5&color=fff&size=128`
                        }),
                        className: "flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                      }, "Save Changes"),
                      React.createElement('button', {
                        onClick: () => setEditingEmployee(null),
                        className: "flex-1 py-2 bg-gray-200 rounded-lg hover:bg-gray-300"
                      }, "Cancel")
                    )
                  )
                )
              )
            );
          }

          return null;
        };

        // Wait for dependencies to load, then render
        const initApp = () => {
          if (window.React && window.ReactDOM && window.supabase) {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(React.createElement(App));
          } else {
            setTimeout(initApp, 100);
          }
        };

        // Load Supabase if not already loaded
        if (!window.supabase) {
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/index.min.js';
          script.onload = () => {
            window.supabase = window.supabase || {};
            initApp();
          };
          document.head.appendChild(script);
        } else {
          initApp();
        }
    </script>
</body>
</html>
